<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReelPoster - Facebook Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1877F2;
            --primary-dark: #166FE5;
            --secondary: #42B72A;
            --light: #F0F2F5;
            --dark: #1C1E21;
            --gray: #8A8D91;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .login-container {
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        
        .login-card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .login-title {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 24px;
        }
        
        .login-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: background-color 0.3s;
        }
        
        .login-btn:hover {
            background-color: var(--primary-dark);
        }
        
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        
        .status.error {
            background-color: #ffebee;
            color: #d32f2f;
            display: block;
        }
        
        .status.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            display: block;
        }
        
        .status.info {
            background-color: #e3f2fd;
            color: #1565c0;
            display: block;
        }
        
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--primary);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 10px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .app-container {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .logout-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <h1 class="login-title">ReelPoster</h1>
            <p>Connect your Facebook account to schedule Reels</p>
            <button class="login-btn" id="fbLoginBtn">
                <i class="fab fa-facebook"></i> Continue with Facebook
            </button>
            <div class="spinner" id="spinner"></div>
            <div class="status info" id="status"></div>
        </div>
    </div>
    
    <!-- Main App (hidden initially) -->
    <div class="app-container" id="appContainer">
        <div id="userInfoContainer">
            <div class="user-info">
                <img id="userAvatar" class="user-avatar" src="" alt="Profile Picture">
                <div>
                    <h3 id="userName"></h3>
                    <p id="userEmail"></p>
                </div>
            </div>
            <h3>Your Facebook Pages:</h3>
            <ul id="pagesList"></ul>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>

    <script>
        // Replace with your actual Facebook App ID
        const FB_APP_ID = 'YOUR_APP_ID';
        
        // DOM Elements
        const loginContainer = document.getElementById('loginContainer');
        const appContainer = document.getElementById('appContainer');
        const fbLoginBtn = document.getElementById('fbLoginBtn');
        const statusEl = document.getElementById('status');
        const spinner = document.getElementById('spinner');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Initialize status
        updateStatus('Checking login status...', 'info');
        
        // 1. Initialize Facebook SDK
        window.fbAsyncInit = function() {
            FB.init({
                appId: FB_APP_ID,
                cookie: true,
                xfbml: true,
                version: 'v19.0'
            });
            
            // Check login status
            checkLoginStatus();
        };

        // 2. Load the Facebook SDK
        (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        // 3. Check login status
        function checkLoginStatus() {
            showSpinner();
            FB.getLoginStatus(function(response) {
                hideSpinner();
                statusChangeCallback(response);
            }, true); // Force a fresh check
        }

        // 4. Login status callback
        function statusChangeCallback(response) {
            console.log('statusChangeCallback');
            console.log(response);
            
            if (response.status === 'connected') {
                // User is logged in and authorized your app
                updateStatus('Login successful! Loading your information...', 'success');
                handleLogin(response.authResponse);
            } else {
                // User is not logged in or hasn't authorized your app
                updateStatus('Please log in with Facebook to continue', 'info');
                showLoginUI();
            }
        }

        // 5. Handle login button click
        fbLoginBtn.addEventListener('click', function() {
            showSpinner();
            updateStatus('Connecting to Facebook...', 'info');
            
            FB.login(function(response) {
                hideSpinner();
                
                if (response.authResponse) {
                    updateStatus('Login successful! Loading your information...', 'success');
                    handleLogin(response.authResponse);
                } else {
                    if (response.status === 'not_authorized') {
                        updateStatus('You need to authorize the app to continue', 'error');
                    } else {
                        updateStatus('Login cancelled or an error occurred', 'error');
                    }
                }
            }, {
                scope: 'public_profile,email,pages_manage_posts,pages_read_engagement',
                return_scopes: true
            });
        }, false);

        // 6. Handle successful login
        function handleLogin(authResponse) {
            showSpinner();
            const accessToken = authResponse.accessToken;
            
            // Get user info
            FB.api('/me', {fields: 'name,email,picture.width(200)'}, function(userResponse) {
                if (userResponse && !userResponse.error) {
                    // Get pages user manages
                    FB.api('/me/accounts', function(pagesResponse) {
                        hideSpinner();
                        
                        if (pagesResponse && !pagesResponse.error && pagesResponse.data) {
                            showAppUI(userResponse, pagesResponse.data);
                        } else {
                            updateStatus('Error loading your pages. Please try again.', 'error');
                            console.error('Error getting pages:', pagesResponse.error);
                        }
                    });
                } else {
                    hideSpinner();
                    updateStatus('Error loading user information. Please try again.', 'error');
                    console.error('Error getting user info:', userResponse.error);
                }
            });
        }

        // 7. Show the main app UI
        function showAppUI(user, pages) {
            loginContainer.style.display = 'none';
            appContainer.style.display = 'block';
            
            // Display user info
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userEmail').textContent = user.email || 'Email not provided';
            document.getElementById('userAvatar').src = user.picture.data.url;
            
            // Display pages
            const pagesList = document.getElementById('pagesList');
            pagesList.innerHTML = '';
            
            if (pages.length > 0) {
                pages.forEach(page => {
                    const li = document.createElement('li');
                    li.textContent = `${page.name} (${page.id})`;
                    pagesList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = 'No pages found';
                pagesList.appendChild(li);
            }
        }

        // 8. Show login UI
        function showLoginUI() {
            loginContainer.style.display = 'flex';
            appContainer.style.display = 'none';
        }

        // 9. Logout functionality
        logoutBtn.addEventListener('click', function() {
            showSpinner();
            FB.logout(function(response) {
                hideSpinner();
                showLoginUI();
                updateStatus('Logged out successfully', 'success');
            });
        });

        // Helper functions
        function updateStatus(message, type) {
            statusEl.textContent = message;
            statusEl.className = 'status ' + (type || 'info');
        }

        function showSpinner() {
            spinner.style.display = 'block';
        }

        function hideSpinner() {
            spinner.style.display = 'none';
        }
    </script>
</body>
</html>
